# 2026-01-13 學習日誌：Neovim

- [ ] 補記安裝 latex parser for nvim-treesitter

## 安裝 latex parser for nvim-treesitter

因為版本袂配合，叫 Warp AI 創真久，勉強手動安裝一个會使罔用个 LaTeX parser
佇 `~/.local/share/nvim/site/parser/latex.so`

Warp AI: At this point, you should not let nvim-treesitter try to install/update
latex again, because its installer is hard‑wired (in your pinned 0.10.0) to call
tree-sitter generate --no-bindings, which will always fail with your CLI.

So the goal is:

1. Keep using your manual parser.
2. Stop nvim-treesitter from trying to auto‑install/update LaTeX.

There are two practical parts:

1. Don’t manually run :TSInstall latex or :TSUpdate latex

Those commands always go through the plugin’s installer (which calls tree-sitter
generate --no-bindings), so for LaTeX specifically:

•  Don’t run :TSInstall latex.
•  Don’t run :TSUpdate latex.

Your parser is already compiled and loaded from
~/.local/share/nvim/site/parser/latex.so. You can still safely run:

```vim
:TSInstallInfo latex
:TSBufEnable highlight
:TSModuleInfo
```

Khoguan: `:TSModuleInfo` 會共咱顯示到底有啥功能有作用。

2. Tell nvim-treesitter to ignore LaTeX for auto‑installation

Khoguan: Warp AI 有共我寫一个 `lua/plugins/latex-ignore-install.lua
來做即个代誌。

Warp AI: TL;DR for your workflow

- LaTeX Treesitter is now working via your manual latex.so.
- Leave it that way; avoid :TSInstall latex and :TSUpdate latex.
- Use the latex-ignore-install.lua override so AstroNvim / nvim‑treesitter won’t
try to be clever and reinstall LaTeX in the background.

我：Now I'd like to refine the highlight query. The current simlified version
is not working satisfactorily. For example, `\documentclass`, `\usepackage`,
`\begin{document}` commands are not highlighted but `\title`, `\author` are. Is
this behavior normal?

Warp AI: I’ll extend your custom LaTeX highlight queries to specifically
highlight \documentclass, \usepackage, and \begin/\end as important commands,
while still avoiding patterns that caused earlier errors.

You’re right to notice that behavior: with the *minimal* query set we
installed, it’s “normal” that `\title`/`\author` were clearly highlighted while
`\documentclass`, `\usepackage`, and `\begin{document}` weren’t, because:

- `\title` / `\author` are matched by the `title_declaration`
/ `author_declaration` patterns and get `@module`, which your colorscheme
probably styles prominently.

- `\documentclass` / `\usepackage` / `\begin{...}` were only getting the generic
`(command_name) @function`, which may look very similar to normal text in your
theme.

I’ve now refined your LaTeX highlight queries to treat the main document/setup
commands specially.

### What changed in `highlights.scm`

In `~/.config/nvim/queries/latex/highlights.scm` I added specific patterns for:

- `class_include` → `\documentclass`
- `package_include` → `\usepackage` / `\RequirePackage`
- `begin` / `end` → `\begin{...}` / `\end{...}`

The relevant section now looks like:

```scheme path="~/.config/nvim/queries/latex/highlights.scm" start=26 end=56
; Document setup commands
(class_include
  command: _ @keyword.import
  path: (curly_group_path) @string)

(package_include
  command: _ @keyword.import
  paths: (curly_group_path_list) @string)

; Begin/end environments (e.g. \begin{document})
(begin
  command: _ @module)

(end
  command: _ @module)

; Sections: just highlight the commands
(title_declaration
  command: _ @module)

(author_declaration
  command: _ @module)

(section
  command: _ @module)

(subsection
  command: _ @module)

(subsubsection
  command: _ @module)
```

Everything else from the minimal file is still there (commands, math, comments,
etc.), and we still avoid any patterns that mention `curly_group_text_list` in
tricky ways.

### What you should see now

After restarting Neovim and reopening your `.tex` test file:

- `\documentclass{article}`:
  - `\documentclass` should be highlighted as `@keyword.import`.
  - The `{article}` part as `@string` (depending on your theme).
- `\usepackage[...]{amsmath}`:
  - `\usepackage` / `\RequirePackage` as `@keyword.import`.
  - The package names as `@string`.
- `\begin{document}` / `\end{document}`:
  - `\begin` / `\end` as `@module`, same group as `\title` / `\author` / sectioning commands in this setup.

If your colorscheme defines distinct colors for `@keyword.import` and
`@module`, these should now “pop” similarly to how `\title`/`\author` do.

### If some still don’t look right

Run in Neovim on your LaTeX buffer:

```vim
:TSPlaygroundToggle
```
(or `:InspectTree` if you use that) and hover the cursor over `\documentclass` / `\usepackage` / `\begin`; check:

- The syntax group (e.g. `@keyword.import`, `@module`, `@function`).
- The underlying node (`class_include`, `package_include`, `begin`, etc.).

If something expected isn’t tagged as `@keyword.import` or `@module`, paste
what `TSPlayground` shows for that node and we can fine‑tune the pattern
further (e.g. match a different node shape or field).
