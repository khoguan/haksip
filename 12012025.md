# 2025-12-01 學習日誌

- [x] 買 Data structures & algorithms 冊
- [x] remove fpc building messages about outdated flags
- [x] 將 .vimrc 內底个 abbreviation 整合過來 Neovim

## 買 Data structures & algorithms 冊

昨昏暗開 3500 佇 No Starch 網站買 5 本 DSA 方面个冊。

- Data structures the Fun Way
- Algorithmic Thinking 2E
- Dive Into Algorithms
- Graph Algorithms the Fun Way
- Recursive Book of Recursion

## remove fpc building messages about outdated flags

我問 Warp AI，使用 fpc 建置程式个時攏會出現以下个訊息：

> -macosx_version_min has been renamed to -macos_version_min
> ld: warning: -multiply_defined is obsolete

伊講 fpc 針對 Mac 平台 hardcode 遮个 flags，無法度用 config file 來消除，所以
就寫一个 wrapper script `~/bin/fpc-quiet`:

```bash
#!/bin/bash
# Wrapper script for FPC that filters out the annoying linker warnings

# Run FPC and filter out the specific warnings
/opt/homebrew/bin/fpc "$@" 2>&1 | grep -v "macosx_version_min has been renamed to -macos_version_min" | grep -v "ld: warning: -multiply_defined is obsolete"
exit ${PIPESTATUS[0]}
```

## 將 .vimrc 內底个 abbreviation 整合過來 Neovim

以下是佮 Warp AI 个討論：
USER:
My `.vimrc` has many iabb commands like this:
```
iabb startpl #!/usr/bin/env perl<cr><cr>
iabb startspl #!/usr/bin/env perl<cr><cr>use strict;<cr>use warnings;<cr>
iabb startmpl #!/usr/bin/env perl<cr>use Modern::Perl;<cr>use utf8;
iabb cpphead #include <iostream><cr>using namespace std;<cr>
....
```
How to add them into my Neovim configuration?

AGENT:
You can use **exactly the same Vimscript commands in Neovim**, you just need to put them in the right place.

### 1. Quick & simple: global abbreviations in your main config

If you’re okay with these being available in all filetypes:

- If you use `init.vim` (Vimscript): just copy them as-is:

```vim
iabbrev startpl #!/usr/bin/env perl<CR><CR>
iabbrev startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
iabbrev startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
iabbrev cpphead #include <iostream><CR>using namespace std;<CR>
```
Note:
- `iabb` is just a short form for `iabbrev`; use either.
- Use uppercase `<CR>` (same as you had).

If you use `init.lua`, wrap them in `vim.cmd`:

```lua
vim.cmd([[
  iabbrev startpl #!/usr/bin/env perl<CR><CR>
  iabbrev startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
  iabbrev startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
  iabbrev cpphead #include <iostream><CR>using namespace std;<CR>
]])
```
### 2. Better: make them filetype-specific

Since `startpl`/`startspl`/`startmpl` are Perl, and `cpphead` is C++, it’s nicer to scope them by filetype.

#### Vimscript configs (`init.vim`)

Create these files and put the abbreviations there:

- `~/.config/nvim/after/ftplugin/perl.vim`:

```vim
iabbrev <buffer> startpl  #!/usr/bin/env perl<CR><CR>
iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
```
- `~/.config/nvim/after/ftplugin/cpp.vim`:

```vim
iabbrev <buffer> cpphead #include <iostream><CR>using namespace std;<CR>
```
`<buffer>` keeps them local to that filetype.

#### Lua configs (`init.lua`)

You can use `vim.cmd` inside a `FileType` autocommand:

```lua
vim.api.nvim_create_autocmd("FileType", {
  pattern = "perl",
  callback = function()
    vim.cmd([[
      iabbrev <buffer> startpl  #!/usr/bin/env perl<CR><CR>
      iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
      iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
    ]])
  end,
})

vim.api.nvim_create_autocmd("FileType", {
  pattern = "cpp",
  callback = function()
    vim.cmd([[
      iabbrev <buffer> cpphead #include <iostream><CR>using namespace std;<CR>
    ]])
  end,
})
```
---

If you tell me whether you’re currently on `init.vim` or `init.lua` (or a specific Neovim distro), I can show you exactly where to paste these in your current setup.

USER:
I am using ~/.config/nvim/init.lua

AGENT:
Since you’re using `~/.config/nvim/init.lua`, the cleanest way is to define filetype‑specific abbreviations via Lua autocommands.

You can add something like this to your `init.lua` (or to a separate Lua module that `init.lua` requires):

```lua
-- Perl abbreviations
vim.api.nvim_create_autocmd("FileType", {
  pattern = "perl",
  callback = function()
    vim.cmd([[
      iabbrev <buffer> startpl  #!/usr/bin/env perl<CR><CR>
      iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
      iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
    ]])
  end,
})

-- C++ abbreviations
vim.api.nvim_create_autocmd("FileType", {
  pattern = "cpp",
  callback = function()
    vim.cmd([[
      iabbrev <buffer> cpphead #include <iostream><CR>using namespace std;<CR>
    ]])
  end,
})
```
Notes:

- This mirrors your old `.vimrc` `iabb` lines, but:
  - Uses the full command `iabbrev`.
  - Adds `<buffer>` so they only apply to that filetype’s buffers.
- The `<CR>` syntax is exactly the same as in Vim.
- `#include <iostream>` is fine as-is; in an abbreviation it’s treated as literal text.

If you prefer them **global** (available in all filetypes), you can just put a single `vim.cmd` block in `init.lua`:

```lua
vim.cmd([[
  iabbrev startpl  #!/usr/bin/env perl<CR><CR>
  iabbrev startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
  iabbrev startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
  iabbrev cpphead  #include <iostream><CR>using namespace std;<CR>
]])
```
If you show the top of your `init.lua`, I can suggest an exact spot to place these so they fit your current structure.

USER:
The full iaabrev lines in my ~/.vimrc are:
`
iabb startpl #!/usr/bin/env perl<cr><cr>
iabb startspl #!/usr/bin/env perl<cr><cr>use strict;<cr>use warnings;<cr>
iabb startmpl #!/usr/bin/env perl<cr>use Modern::Perl;<cr>use utf8;
iabb cpphead #include <iostream><cr>using namespace std;<cr>
iabb cppfac #include "std_lib_facilities.h"<cr>int main()<cr>{<cr>
iabb startpy #!/usr/bin/env python3
iabb startruby #!/usr/bin/env ruby
iabb initz initialize
iabb startsca #!/usr/bin/env scala<cr>
iabb startscain #!/usr/bin/env scala<cr>import scala.io.StdIn._<cr>
iabb sraku #!/usr/bin/env raku
iabb snode #!/usr/bin/env node
iabb sbash #!/usr/bin/env bash
iabb blogdia ---<cr>layout: post<cr>title: <cr>date: <cr>author: 潘科元<cr>categories: [日記]<cr>---<cr>## 學習台語<cr><cr><cr>## 學習日語<cr><cr><cr>## 學習電腦
iabb fbcomm ## 面冊網誌留言
iabb tbl {:target="_blank"}
```

And my Neovim config is located at `~/.config/nvim`. Please migrate the above iabbrev lines into the suitable positions in my Neovim config.

AGENT:
Before I edit your Neovim config, please git-add and git-commit any untracked or modified files so it’s clear what changes come from this session. I’ll now inspect your `~/.config/nvim` to find the best place to add these abbreviations.

Here’s what I’ve done and how it maps to your original `.vimrc` abbreviations.

## 1. Where your abbreviations now live

They are already migrated into `~/.config/nvim/lua/khoguan/iabbrev.lua`. That file contains:

- **Filetype-local abbreviations** for Perl and C++:

```lua path="~/.config/nvim/lua/khoguan/iabbrev.lua" start=3 end=24
-- Perl abbreviations
vim.api.nvim_create_autocmd("FileType", {
  pattern = "perl",
  callback = function()
    vim.cmd [[
      iabbrev <buffer> startpl  #!/usr/bin/env perl<CR><CR>
      iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
      iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
    ]]
  end,
})

-- C++ abbreviations
vim.api.nvim_create_autocmd("FileType", {
  pattern = "cpp",
  callback = function()
    vim.cmd [[
      iabbrev <buffer> cpphead #include <iostream><CR>using namespace std;<CR>
      iabbrev cppfac #include "std_lib_facilities.h"<cr>int main()<cr>{<cr>
    ]]
  end,
})
```
- **Global abbreviations** matching your other `iabb` lines:

```lua path="~/.config/nvim/lua/khoguan/iabbrev.lua" start=26 end=38
vim.cmd [[
iabbrev startpy #!/usr/bin/env python3
iabbrev startruby #!/usr/bin/env ruby
iabbrev initz initialize
iabbrev startsca #!/usr/bin/env scala<cr>
iabbrev startscain #!/usr/bin/env scala<cr>import scala.io.StdIn._<cr>
iabbrev sraku #!/usr/bin/env raku
iabbrev snode #!/usr/bin/env node
iabbrev sbash #!/usr/bin/env bash
iabbrev blogdia ---<cr>layout: post<cr>title: <cr>date: <cr>author: 潘科元<cr>categories: [日記]<cr>---<cr>## 學習台語<cr><cr><cr>## 學習日語<cr><cr><cr>## 學習電腦
iabbrev fbcomm ## 面冊網誌留言
iabbrev tbl {:target="_blank"}
]]
```
These lines are direct migrations of your `.vimrc`:

- `startpl`, `startspl`, `startmpl` → Perl, buffer-local.
- `cpphead`, `cppfac` → C++ (with `cpphead` buffer-local).
- `startpy`, `startruby`, `initz`, `startsca`, `startscain`, `sraku`, `snode`,
  `sbash`, `blogdia`, `fbcomm`, `tbl` → global abbreviations, same as in `.vimrc`.

Lowercase `<cr>` is fine in Neovim; it behaves the same as `<CR>`.

## 2. Making sure Neovim actually loads them

Previously, `lua/khoguan/iabbrev.lua` wasn’t being required anywhere, so the
abbreviations wouldn’t take effect. I wired it into your main config by editing
`~/.config/nvim/init.lua` to require this module:

```lua path="~/.config/nvim/init.lua" start=26 end=38
vim.opt.rtp:prepend(lazypath)

-- validate that lazy is available
if not pcall(require, "lazy") then
  -- ...
end

-- Khoguan try to work around treesitter bug for `J` command in MD
vim.g.markdown_disable_treesitter = 1

require "lazy_setup"
require "polish"
require "khoguan.iabbrev"
```
So on startup Neovim will:

1. Set up Lazy and AstroNvim.
2. Run `polish` (currently disabled by the guard inside that file).
3. **Run `khoguan.iabbrev`**, which:
   - Registers the `FileType` autocommands for Perl and C++ abbreviations.
   - Defines your global `iabbrev` entries.

## 3. How to verify

In Neovim:

- Open a Perl file: `:e test.pl`
  - Type `startpl` in insert mode followed by a space or punctuation.  
    It should expand to:

```perl
    #!/usr/bin/env perl

```
- Open a C++ file: `:e test.cpp`
  - Type `cpphead` + space → expands to the `iostream` header and `using namespace std;`.
  - Type `cppfac` + space → expands your `std_lib_facilities.h` skeleton.

- In any buffer:
  - Type `startpy` + space → `#!/usr/bin/env python3`
  - Type `blogdia` + space → full blog front-matter and headings.

If anything doesn’t behave as you expect (e.g. you want more of them to be
filetype-local instead of global), we can tweak `iabbrev.lua` accordingly.

USER:
There's an error when I restart nvim:
```
 11:42           lazy.nvim       Invalid spec module: `khoguan.iabbrev` Expected
a `table` of specs, but a `nil` was returned instead
```

AGENT:

I found that `lua/khoguan/iabbrev.lua` is being treated as a Lazy plugin spec
via `{ import = "khoguan" }`, but it doesn’t return a spec table, which causes
the error. I’ll update that file to return a valid spec so Lazy is happy while
keeping your abbreviations unchanged. Before I edit your config, please `git
add`/`git commit` any existing changes so you can clearly see what I modify.


**Diff:**
```diff
--- ~/.config/nvim/lua/khoguan/iabbrev.lua
+++ ~/.config/nvim/lua/khoguan/iabbrev.lua
@@ -37,3 +37,7 @@
 iabbrev fbcomm ## 面冊網誌留言
 iabbrev tbl {:target="_blank"}
 ]]
+
+return {
+  "AstroNvim/astrocore",
+}

```

It looks like my patch attempt got mangled because it accidentally included line
prefixes; I didn’t actually update the file correctly. Let me instead explain
the fix so you can apply it cleanly.

### What’s going wrong

- `lazy_setup.lua` contains:

```lua
  { import = "khoguan" },
```
  This tells `lazy.nvim` to treat every module under `lua/khoguan/*.lua` as a **plugin spec module**.
- Files like `khoguan/options.lua`, `khoguan/mappings.lua`, etc. correctly `return { ... }` plugin specs.
- `khoguan/iabbrev.lua` **does not return anything**; it just runs commands:

```lua path="~/.config/nvim/lua/khoguan/iabbrev.lua" start=1 end=39
  -- <buffer> after `iabbrev` keeps them local to that filetype.

  -- Perl abbreviations
  vim.api.nvim_create_autocmd("FileType", {
    pattern = "perl",
    callback = function()
      vim.cmd [[
        iabbrev <buffer> startpl  #!/usr/bin/env perl<CR><CR>
        iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;<CR>
        iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
      ]]
    end,
  })

  -- C++ abbreviations
  vim.api.nvim_create_autocmd("FileType", {
    pattern = "cpp",
    callback = function()
      vim.cmd [[
        iabbrev <buffer> cpphead #include <iostream><CR>using namespace std;<CR>
        iabbrev cppfac #include "std_lib_facilities.h"<cr>int main()<cr>{<cr>
      ]]
    end,
  })

  -- or globally set the abbreviations
  vim.cmd [[
  iabbrev startpy #!/usr/bin/env python3
  iabbrev startruby #!/usr/bin/env ruby
  iabbrev initz initialize
  iabbrev startsca #!/usr/bin/env scala<cr>
  iabbrev startscain #!/usr/bin/env scala<cr>import scala.io.StdIn._<cr>
  iabbrev sraku #!/usr/bin/env raku
  iabbrev snode #!/usr/bin/env node
  iabbrev sbash #!/usr/bin/env bash
  iabbrev blogdia ---<cr>layout: post<cr>title: <cr>date: <cr>author: 潘科元<cr>categories: [日記]<cr>---<cr>## 學習台語<cr><cr><cr>## 學習日語<cr><cr><cr>## 學習電腦
  iabbrev fbcomm ## 面冊網誌留言
  iabbrev tbl {:target="_blank"}
  ]]
```
- When `lazy` tries to import `khoguan.iabbrev` as a spec, it gets `nil` and shows:

  > Invalid spec module: `khoguan.iabbrev` Expected a `table` of specs, but a `nil` was returned instead

### Minimal fix

Keep all your autocommands/abbreviations exactly as they are and just make
`iabbrev.lua` return a valid spec table so Lazy is satisfied.

At the **end** of `lua/khoguan/iabbrev.lua`, after the existing `vim.cmd [[ ... ]]` block, add:

```lua path="~/.config/nvim/lua/khoguan/iabbrev.lua" start=41 end=43
return {
  "AstroNvim/astrocore",
}
```
So the file ends like this (only the tail shown):

```lua
  iabbrev blogdia ---<cr>layout: post<cr>title: <cr>date: <cr>author: 潘科元<cr>categories: [日記]<cr>---<cr>## 學習台語<cr><cr><cr>## 學習日語<cr><cr><cr>## 學習電腦
  iabbrev fbcomm ## 面冊網誌留言
  iabbrev tbl {:target="_blank"}
]]
return {
  "AstroNvim/astrocore",
}
```
Notes:

- The top-level code (autocmds + `vim.cmd [[...]]`) will still run when the
  module is required (by Lazy), so your abbreviations continue to work.
- Returning a spec for `"AstroNvim/astrocore"` is consistent with your other
  `khoguan/*.lua` files and keeps everything integrated under AstroNvim.

### Optional cleanup

Since Lazy is now the one requiring `khoguan.iabbrev`, you can optionally remove this line from `init.lua`:

```lua path="~/.config/nvim/init.lua" start=29 end=31
require "lazy_setup"
require "polish"
require "khoguan.iabbrev"  -- <- this can be removed if you like
```
That’s not required to fix the error; the essential change is adding the `return { "AstroNvim/astrocore", }` at the end of `khoguan/iabbrev.lua`.

If you’d like, I can try another precise patch just for that file, but the manual edit above should get rid of the Lazy error immediately.

USER:
It's working now. But a new issue with my Neovim setup arises. The `<CR>` in my abbreviations will be prefixed with an extra `#` sign which doesn't exist in my abbreviation. For example, I type `spl` and expect to see

```
#!/usr/bin/env perl

use strict;
use warnings;
```

But Neovim gives me:

```
#!/usr/bin/env perl
#
#use strict;
#use warnings;
```

It looks like that some Neovim plugin is modifying my abbreviations.

AGENT:

**Diff:**
```diff
--- ~/.config/nvim/lua/khoguan/iabbrev.lua
+++ ~/.config/nvim/lua/khoguan/iabbrev.lua
@@ -4,6 +4,10 @@
 vim.api.nvim_create_autocmd("FileType", {
   pattern = "perl",
   callback = function()
+    -- Prevent automatic comment leader insertion ("#") on new lines
+    -- which interferes with multi-line abbreviations
+    vim.opt_local.formatoptions:remove { "r", "o" }
+
     vim.cmd [[
       iabbrev <buffer> startpl  #!/usr/bin/env perl
       iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;

```

The extra `#` is coming from Neovim’s automatic “continue comment on new line” behavior, not from the abbreviation itself.

When you expand an abbreviation that contains `<CR>` inside a line that starts with `#!` (a Perl comment/shebang), Neovim sees that as a comment line. With `formatoptions` containing `r`/`o`, each `<CR>` inserts a new line that automatically gets a `#` comment leader. That’s why your result looks like:

```text
#!/usr/bin/env perl
#
#use strict;
#use warnings;
```
### Fix: disable auto comment continuation for Perl

You already have a `FileType` autocmd for `perl` in `lua/khoguan/iabbrev.lua`. I’ve updated it so that, when you open a Perl buffer, it removes the `r` and `o` flags from `formatoptions` (for that buffer only):

```lua path="~/.config/nvim/lua/khoguan/iabbrev.lua" start=3 end=17
-- Perl abbreviations
vim.api.nvim_create_autocmd("FileType", {
  pattern = "perl",
  callback = function()
    -- Prevent automatic comment leader insertion ("#") on new lines
    -- which interferes with multi-line abbreviations
    vim.opt_local.formatoptions:remove { "r", "o" }

    vim.cmd [[
      iabbrev <buffer> startpl  #!/usr/bin/env perl
      iabbrev <buffer> startspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;
      iabbrev <buffer> startmpl #!/usr/bin/env perl<CR>use Modern::Perl;<CR>use utf8;
    ]]
  end,
})
```
This does two things:

- Keeps your abbreviations exactly as you wrote them.
- Stops Neovim (or any plugin that tweaks `formatoptions`) from auto-prefixing new lines with `#` in Perl buffers.

After this change:

1. Restart Neovim (or `:luafile` this file and reopen a Perl buffer).
2. In a `perl` buffer, do `:setlocal fo?` — you should see `r` and `o` gone.
3. Trigger your `startspl` abbreviation again; you should now get:

```text
#!/usr/bin/env perl

use strict;
use warnings;
```
If you’d prefer to keep comment continuation for normal typing but only “fix” these specific abbreviations, I can show an alternative version that uses `<C-u>` inside the abbreviation to strip any auto-inserted `#` per `<CR>`.

USER:
The extra `#` issus is fixed now. One more question: I type `smartspl` and then only type Space key can the abbreviation be expanded. If I just type Enter key without typing a space first. The abbreviation won't work. But the old Vim will. Is this a feature of Neovim?

AGENT:
Neovim itself can expand insert-mode abbreviations on `<CR>` just like Vim; what you’re seeing is almost certainly from your config/plugins remapping `<CR>` in Insert mode.

### Why `<CR>` no longer expands your abbrev

Abbreviations expand when:

- You type the abbreviation text (e.g. `smartspl`), and  
- Then type a **non-keyword** character (space, `;`, `<CR>`, etc.) that is *inserted normally*.

If `<CR>` is **mapped** in Insert mode (very common in modern Neovim configs for completion), Neovim runs the mapping instead of doing the normal “insert newline and then check for abbrev” behavior. That means:

- Space still expands the abbrev (no mapping on `<Space>`).
- `<CR>` triggers your completion/other mapping instead, so the abbrev isn’t expanded.

In AstroNvim-style setups, `<CR>` in Insert mode is usually mapped to confirm completion, handle autopairs, etc., which overrides the plain abbreviation expansion.

### How to confirm

In Neovim, run:

```vim
:verbose imap <CR>
```
You’ll see which plugin or config defined the `<CR>` mapping. If you temporarily remove it:

```vim
:iunmap <CR>
```
then try `smartspl<CR>` again — it should expand like in old Vim.

You can also verify this by starting Neovim clean:

```bash
nvim -u NONE
```
Define a quick abbrev:

```vim
:iabbrev smartspl #!/usr/bin/env perl<CR><CR>use strict;<CR>use warnings;
```
Then `smartspl<CR>` will expand correctly — showing that core Neovim supports `<CR>`-triggered abbreviations; it’s your config that changes it.

### Options if you want old behavior back

You have three main choices:

1. **Unmap or simplify `<CR>` in Insert mode**  
   Remove or adjust the `<CR>` insert mapping from your completion/autopairs setup so `<CR>` behaves more like stock Vim. This may slightly change how completion behaves.

2. **Use a different key to confirm completion**  
   For example, keep completion on `<C-y>` or `<Tab>` and let `<CR>` stay “plain”, so abbreviations will expand on `<CR>` again.

3. **Manually expand when needed**  
   You can always force expansion with `<C-]>` in Insert mode:

   - Type `smartspl`
   - Press `<C-]>`  

   That triggers `:help i_CTRL-]` expansion regardless of the next character.

If you’d like, I can help you locate and adjust the exact `<CR>` mapping in your current config so abbreviations work on `<CR>` again without breaking your completion too much.

USER:
OK. I ran `:verbose imap <CR>` and got this:
```
i  <CR>        * v:lua.require'nvim-autopairs'.completion_confirm()                              
        Last set from ~/.config/nvim/init.lua (run Nvim with -V1 for more details)
```

AGENT:

_Grep error: Grep command exited with non-zero exit code, output:
fatal: -e option, 'imap("<CR>': parentheses not balanced
 _

**Grep Results:**

Neovim itself can expand insert-mode abbreviations on `<CR>` just like “old
Vim”. What’s changing the behavior is this mapping:

```vim
i  <CR>  v:lua.require'nvim-autopairs'.completion_confirm()
```

That’s from the `nvim-autopairs` plugin. Because `<CR>` is mapped, Neovim runs
that Lua function instead of doing the normal “insert newline and then expand
abbreviation” behavior, so your `smartspl` only expands on Space (or other
unmapped non-keyword chars), not on Enter.

So this is not a core Neovim feature; it’s a side effect of that plugin mapping.

---

### Simple way to restore `<CR>` abbreviation expansion

If you’re happy to give up `nvim-autopairs`’ special `<CR>` behavior, you can
override that mapping so `<CR>` is “plain” again.

For example, somewhere in your config that runs after plugins load (e.g.
a custom mappings file), add:

```lua
vim.keymap.set("i", "<CR>", "<CR>", { noremap = true })
```
After restarting Neovim:

- `smartspl<Space>` will still expand (as before).
- `smartspl<CR>` will also expand, like in old Vim.
- You’ll lose the autopairs “smart confirm on `<CR>`” behavior, but normal
  autopairs pairing (`(` → `()`, etc.) will still work.

---

### Cleaner option: disable autopairs’ `<CR>` mapping via its config

If you prefer to configure the plugin directly (recommended, especially with
Lazy/AstroNvim), create a small plugin override such as
`lua/plugins/autopairs.lua`:

```lua
return {
  "windwp/nvim-autopairs",
  opts = {
    map_cr = false,  -- turn off the <CR> mapping
  },
}
```
With `map_cr = false`, `nvim-autopairs` stops installing the `<CR>` mapping, so:

- `<CR>` becomes the default Neovim Enter again (abbreviations work).
- Autopairs still handles pairs, but doesn’t hijack Enter.

---

If you’d like to keep autopairs’ completion integration on `<CR>` *and* still
have “plain” Enter when no completion menu is visible, I can help you wire up
a custom `expr` mapping that calls `completion_confirm()` only when a completion
is active and otherwise returns a normal `<CR>` so abbreviations expand.
