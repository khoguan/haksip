# 2025-08-14 學習日誌

- [x] 補添進前某一擺个 git commit
- [x] 了解各種 mason tools 佮 none-ls 个關係
- [/] 改用 markdownlint
- [*] 沓沓仔試用各種 MD formatters

## 補添檔案入去舊 commit

進前某一擺个 git commit，袂記得 `git add _stop.lua`，問 Warp AI，
伊用兩條指令：

```shell
git add _stop.lua && git commit --fixup=1e7f068
git rebase -i --autosquash 1e7f068^
```

伊解說第二條指令：

Explain one of your commands: `git rebase -i --autosquash 1e7f068^`

Great question! Let me break down this git rebase command:

### `git rebase -i --autosquash 1e7f068^`

#### Component by component

1. **`git rebase`**: This is the base command that reapplies commits on top of
   another base tip. It's used to integrate changes from one branch to
   another, or in this case, to modify commit history.

2. **`-i` (or `--interactive`)**: This flag opens an interactive rebase session.
   Normally, this would open your text editor with a list of commits, allowing
   you to:
   - Reorder commits
   - Edit commit messages
   - Squash commits together
   - Split commits
   - Delete commits

3. **`--autosquash`**: This is the key flag that made our operation automatic!
   When you create commits with special prefixes like:
   - `fixup!` (which we used: `git commit --fixup=1e7f068`)
   - `squash!`

   The `--autosquash` flag automatically reorders and marks these commits to be
   squashed into their target commits. Without this flag, you'd have to manually
   mark the fixup commit in the interactive editor.

4. **`1e7f068^`**: This specifies the starting point for the rebase:
   - `1e7f068` is the commit hash we wanted to modify
   - The `^` (caret) means "the parent of" - so `1e7f068^` refers to the commit
     immediately before `1e7f068`
   - This tells git to rebase all commits from (but not including) the parent of
     `1e7f068` up to the current HEAD

#### What happened behind the scenes

1. When we ran `git commit --fixup=1e7f068`, git created a new commit with the
   message `fixup! 用正範方法關掉MD autotag` (it automatically copied the
   original commit message with the `fixup!` prefix)

2. During the rebase with `--autosquash`, git:
   - Identified the fixup commit by its special prefix
   - Found the target commit (1e7f068) by matching the message
   - Automatically reordered the commits to place the fixup right after its
     target
   - Marked it to be squashed without changing the commit message
   - Applied all the changes, creating a new commit with combined changes

3. Because we modified history, the commit hash changed from `1e7f068` to
   `abac163`, but it kept the same timestamp, author, and message.

This approach is much cleaner than manually editing during an interactive rebase,
especially when you know exactly which commit you want to modify!

## 了解各種 mason tools 佮 none-ls 个關係

Khoguan: Take a look at `./init.lua`. Why are there 5 plugins?

> [!INFO]
> "nvim-treesitter/nvim-treesitter",
"williamboman/mason-lspconfig.nvim",
"jay-babu/mason-null-ls.nvim",
"WhoIsSethDaniel/mason-tool-installer.nvim",
"stevearc/conform.nvim",

They seem to be doing very similar things?

Warp AI (gpt-5): Great question—these do different jobs and complement each other.
In short: some install things, some wire them up, and others actually run
formatting/linting.

Here’s what each does in your init.lua:

- nvim-treesitter/nvim-treesitter
  - Purpose: Syntax parsing/highlighting/indent via Tree-sitter grammars.
  - Why here: Adds Lua/Luap parsers to ensure_installed. Not related to
    LSP/formatters at all.

- williamboman/mason-lspconfig.nvim
  - Purpose: Bridge between Mason and lspconfig for LSP servers.
  - Why here: Ensures the lua_ls LSP server is installed and auto-configured
    with lspconfig (AstroNvim/astrolsp also tweaks its settings).

- jay-babu/mason-null-ls.nvim
  - Purpose: Bridge between Mason and null-ls/none-ls for external CLI tools
    (formatters/linters).
  - Why here: Ensures tools like stylua (and selene on non-aarch64) are
    available and, if none-ls/null-ls is present, registers them (note the
    selene handler is conditional on a selene.toml existing). Even if you use
    conform/nvim-lint to run tools, this still helps with ensuring those
    binaries are installed and (optionally) wired into none-ls if enabled
    elsewhere.

- WhoIsSethDaniel/mason-tool-installer.nvim
  - Purpose: Declaratively ensure Mason packages are installed at startup.
  - Why here: Another layer that guarantees binaries (lua-language-server,
    stylua, selene) are installed regardless of which integration is active.
    It’s common in AstroNvim to list tools here so they’re present even if you
    swap formatter/linter runners.

- stevearc/conform.nvim
  - Purpose: The actual formatter runner/invoker.
  - Why here: Configures Lua formatting with stylua. It uses the binaries that
    Mason installs; it’s not an installer itself.

Also present:

- mfussenegger/nvim-lint
  - Purpose: The actual linter runner/invoker.
  - Why here: Runs selene for Lua (when selene.toml exists and you’re not on
    aarch64).

Why it looks redundant

- “ensure_installed” appears in multiple places because each layer serves a
  different pipeline:
  - mason-lspconfig: LSP server install + lspconfig wiring.
  - mason-null-ls: External tools install + optional none-ls registration.
  - mason-tool-installer: Belt-and-suspenders to guarantee the binaries exist.
  - conform/nvim-lint: Actually run formatting/linting using those binaries.
- AstroNvim packs are modular, so they often declare tools in multiple
  integrations so things “just work” whether you’re using none-ls, conform, or
  nvim-lint.

Net effect

- Parse/highlight: nvim-treesitter
- LSP install+setup: mason-lspconfig (+ astrolsp config)
- External tool install (+ optional none-ls hookup): mason-null-ls
- Make sure binaries are installed at startup: mason-tool-installer
- Run formatting: conform.nvim (stylua)
- Run linting: nvim-lint (selene, only when configured)

## 改用 markdownlint 來檢查我个 MD 个欠點

### 比 markdownlint-cli2 利便

比 markdownlint-cli2 个優點就是免先存檔就會使直接檢查矣。只要一个小所在無拄好，
離開 insert mode，進入 normal mode 个時伊就會比出來。當然按呢畫面就會較亂，所以
上好著配合 `<leader>ud` 先將 diagnostics 禁起來，按呢文字中間才袂定定有鑿目个
黃字，干焦狀態列遐會有警示標誌出現爾爾，無要緊，彼聽好寬寬仔處理，先將咱欲寫个
內容寫予好，才來解決格式無好个問題。

### 猶未舞清楚按怎安裝 linter

干焦佇 `none-ls.lua` 遐指定無夠，總是，到底是閣用 `:Mason` 安裝一下就好，抑是
著閣做啥設定，抑是用 shell 透過 brew / npm / pip 等等來安裝，我閣捎無總。

## 沓沓仔試用各種 MD formatters

1. `gq`/`gqp` 處理簡單个單行單段重排閣袂䆀。
2. `deno` 處理 list item 過長个問題袂䆀，拗逝个時知影通勼排。

## Treesitter installed languages

306 个猶未裝，已經裝个干焦 13 个：

```vim
`:redir @t | TSInstallInfo | redir end`
`:put @t`
`:'a,'bg/not installed/d`
```

> bash               [✓] installed
c                  [✓] installed
git_rebase         [✓] installed
html               [✓] installed
lua                [✓] installed
luap               [✓] installed
markdown           [✓] installed
markdown_inline    [✓] installed
python             [✓] installed
query              [✓] installed
vim                [✓] installed
vimdoc             [✓] installed
yaml               [✓] installed

## Treesitter Config Info

`:TSConfigInfo`

```lua
{
  auto_install = true,
  ensure_installed = {
    "markdown", "markdown_inline", "lua",
    "markdown", "markdown_inline",
    "python", "query", "vim", "vimdoc", "luap", "html"
  },
  ignore_install = {},
  modules = {
    auto_install = true,
    autotag = {
      attach = <function 1>,
      detach = <function 2>,
      disable = {},
      enable = false
    },
    highlight = {
      additional_vim_regex_highlighting = false,
      custom_captures = {},
      disable = <function 3>,
      enable = true,
      loaded = true,
      module_path = "nvim-treesitter.highlight"
    },
    incremental_selection = {
      disable = <function 4>,
      enable = true,
      keymaps = {
        init_selection = "gnn",
        node_decremental = "grm",
        node_incremental = "grn",
        scope_incremental = "grc"
      },
      loaded = true,
      module_path = "nvim-treesitter.incremental_selection"
    },
    indent = {
      disable = <function 5>,
      enable = true,
      loaded = true,
      module_path = "nvim-treesitter.indent"
    },
    textobjects = {
      lsp_interop = {
        border = "none",
        disable = {},
        enable = false,
        floating_preview_opts = {},
        module_path = "nvim-treesitter.textobjects.lsp_interop",
        peek_definition_code = {}
      },
      move = {
        disable = {},
        enable = true,
        goto_next = {},
        goto_next_end = {
          ["]A"] = {
            desc = "Next argument end",
            query = "@parameter.inner"
          },
          ["]F"] = {
            desc = "Next function end",
            query = "@function.outer"
          },
          ["]K"] = {
            desc = "Next block end",
            query = "@block.outer"
          }
        },
        goto_next_start = {
          ["]a"] = {
            desc = "Next argument start",
            query = "@parameter.inner"
          },
          ["]f"] = {
            desc = "Next function start",
            query = "@function.outer"
          },
          ["]k"] = {
            desc = "Next block start",
            query = "@block.outer"
          }
        },
        goto_previous = {},
        goto_previous_end = {
          ["[A"] = {
            desc = "Previous argument end",
            query = "@parameter.inner"
          },
          ["[F"] = {
            desc = "Previous function end",
            query = "@function.outer"
          },
          ["[K"] = {
            desc = "Previous block end",
            query = "@block.outer"
          }
        },
        goto_previous_start = {
          ["[a"] = {
            desc = "Previous argument start",
            query = "@parameter.inner"
          },
          ["[f"] = {
            desc = "Previous function start",
            query = "@function.outer"
          },
          ["[k"] = {
            desc = "Previous block start",
            query = "@block.outer"
          }
        },
        loaded = true,
        module_path = "nvim-treesitter.textobjects.move",
        set_jumps = true
      },
      select = {
        disable = {},
        enable = true,
        keymaps = {
          ["a?"] = {
            desc = "around conditional",
            query = "@conditional.outer"
          },
          aa = {
            desc = "around argument",
            query = "@parameter.outer"
          },
          ac = {
            desc = "around class",
            query = "@class.outer"
          },
          af = {
            desc = "around function ",
            query = "@function.outer"
          },
          ak = {
            desc = "around block",
            query = "@block.outer"
          },
          ao = {
            desc = "around loop",
            query = "@loop.outer"
          },
          ["i?"] = {
            desc = "inside conditional",
            query = "@conditional.inner"
          },
          ia = {
            desc = "inside argument",
            query = "@parameter.inner"
          },
          ic = {
            desc = "inside class",
            query = "@class.inner"
          },
          ["if"] = {
            desc = "inside function ",
            query = "@function.inner"
          },
          ik = {
            desc = "inside block",
            query = "@block.inner"
          },
          io = {
            desc = "inside loop",
            query = "@loop.inner"
          }
        },
        loaded = true,
        lookahead = true,
        lookbehind = false,
        module_path = "nvim-treesitter.textobjects.select",
        selection_modes = {}
      },
      swap = {
        disable = {},
        enable = true,
        loaded = true,
        module_path = "nvim-treesitter.textobjects.swap",
        swap_next = {
          [">A"] = {
            desc = "Swap next argument",
            query = "@parameter.inner"
          },
          [">F"] = {
            desc = "Swap next function",
            query = "@function.outer"
          },
          [">K"] = {
            desc = "Swap next block",
            query = "@block.outer"
          }
        },
        swap_previous = {
          ["<A"] = {
            desc = "Swap previous argument",
            query = "@parameter.inner"
          },
          ["<F"] = {
            desc = "Swap previous function",
            query = "@function.outer"
          },
          ["<K"] = {
            desc = "Swap previous block",
            query = "@block.outer"
          }
        }
      }
    },
    ["textobjects.lsp_interop"] = {
      disable = <function 6>
    },
    ["textobjects.move"] = {
      disable = <function 7>
    },
    ["textobjects.select"] = {
      disable = <function 8>
    },
    ["textobjects.swap"] = {
      disable = <function 9>
    }
  },
  sync_install = false
}
```

發現 `ensure_installed` list 內底 `markdown`, `markdown_inline` 攏重複出現，
這就表示某所在無用 require('astrocore').list_insert_unique() 去做插入元素所致。

發現就是 treesitter-markdown.lua 寫了無好，伊用內建个 vim.tbl_extend，無用
astrocore 另外設个，我共伊改過來：

```lua
-- opts.ensure_installed = vim.tbl_extend("force", opts.ensure_installed or {},
-- { "markdown", "markdown_inline" })

    opts.ensure_installed = require("astrocore").list_insert_unique(opts.ensure_installed, {
      "markdown",
      "markdown_inline",
    })
```

改好閣做 `:TSConfigInfo` 就正常矣：

```lua
ensure_installed = { "bash", "c", "lua", "markdown", "markdown_inline", "python",
  "query", "vim", "vimdoc", "luap", "html" },
```

## 設定 markdownlint 使用三个所在个規則檔

Warp AI 替我想著三種使用情境，心適心適。

### Warp AI Summary

Here's how your new setup works:

Configuration Priority (in order):

1. Buffer directory: .markdownlint.yaml in the same folder as the file
2. Git root: .markdownlint.yaml in the git repository root  
3. Home directory: ~/.markdownlint.yaml (your global config)

Common Project Scenarios:

Scenario 1: Documentation projects - might want stricter rules:

```yaml
# .markdownlint.yaml in project root
MD013:
  line_length: 80  # Stricter than global 120
MD041: true       # Require first line to be heading
```

Scenario 2: API documentation - might allow HTML and longer lines:

```yaml
# .markdownlint.yaml in project root  
MD013:
  line_length: 150  # Longer for code examples
MD033: false        # Allow HTML tags
MD046:
  style: "fenced"   # Prefer fenced code blocks
```

Scenario 3: Blog posts - might have different heading styles:

```yaml
# .markdownlint.yaml in project root
MD013:
  line_length: 100
MD025: false  # Allow multiple H1s for blog posts
MD041: false  # Don't require H1 as first line (for frontmatter)
```
