# 2025-08-18 學習日誌

- [ ] 試用 deno fmt 佮 deno.json 來排版 MD
- [ ] git repo 下底个 git submodule
- [ ] AstroNvim treesitter 處理 Markdown 開始重耽
- [I] 今仔日得著三大撇步
- [ ] 安裝 dprint formatter

## 今仔日得著三大撇步

1. `gq` 排版指令會予 prettierd 食去，毋是 prettierd 本身个錯，是 lspconfig
本底就按呢設計。也毋免想盡辦法禁掉 LSP formatter，會使改用 `gw{motion}`, `gww`
指令就好，這是純內部排版指令，袂受 `formatexpr` 佮 `formatprg` 影響。

nvim-lspconfig 說明書：

> [!IMPORTANT]
> Nvim sets some default options and mappings when a buffer attaches to LSP (see [`:help lsp-config`][lsp-config]). In particular:
> 
> * [`'tagfunc'`][tagfunc]
>     - Enables "go to definition" capabilities using [`<C-]>`][tagjump] and other [tag commands][tag-commands].
> * [`'omnifunc'`][omnifunc]
>     - Enables (manual) omni mode completion with `<C-X><C-O>` in Insert mode. For *auto*completion, an [autocompletion plugin](https://github.com/neovim/nvim-lspconfig/wiki/Autocompletion) is required.
> * [`'formatexpr'`][formatexpr]
>     - Enables LSP formatting with [`gq`][gq].
> * `K` maps to [`vim.lsp.buf.hover()`][vim.lsp.buf.hover] in Normal mode.
> * `[d` and `]d` map to `vim.diagnostic.jump()` with `{count=-1}` and
>   `vim.diagnostic.jump()` with `{count=1}`, respectively.
> * `<C-W>d` maps to `vim.diagnostic.open_float()`.
> 
> [lsp-config]: https://neovim.io/doc/user/lsp.html#lsp-config
> [tagfunc]: https://neovim.io/doc/user/tagsrch.html#tag-function
> [omnifunc]: https://neovim.io/doc/user/options.html#'omnifunc'
> [formatexpr]: https://neovim.io/doc/user/options.html#'formatexpr'
> [gq]: https://neovim.io/doc/user/change.html#gq
> [vim.lsp.buf.hover]: https://neovim.io/doc/user/lsp.html#vim.lsp.buf.hover()
> [tagjump]: https://neovim.io/doc/user/tagsrch.html#CTRL-%5D
> [tag-commands]: https://neovim.io/doc/user/tagsrch.html#tag-commands

2. AstroNvim 佇 Markdown `J` 指令引起 treesitter 出錯：
   `:set foldmethod=manual` 閣來 `:set foldmethod=expr`

3. 欲愛 AstroNvim 个 folding 功能，免規个採用 AstroNvim，只要複製伊 5
   个檔案就好：
   1. _astrocore.lua
   2. _astrocore_mappings.lua
   3. _astroui.lua
   4. _astroui_status.lua
   5. heirline.lua

## 試用 deno fmt 佮 deno.json 來排版 MD

原來 deno 是 JS 世界个物件，但是伊个 deno fmt 會使處理真濟檔案類型，看副檔名
就有法度適當排版，也有設定檔 deno.json 通指定，伊會對本檔所在个目錄開始揣起，
一直揣起去頂懸棧。我佇 ~/Hak 遮設一个 `deno.json`，因為愛特別指定行長袂使傷長，
先設 70 看覓。

```json
{
  "fmt": {
    "useTabs": false,
    "lineWidth": 70,
    "indentWidth": 2,
    "semiColons": false,
    "singleQuote": false,
    "proseWrap": "always"
  }
}
```

參考進前 Warp AI 替我寫个設定來做，試了是會排，總是，排了無媠，伊無了解漢字个
標點，袂曉揣全型標點个所在來拗逝，會提早佇英文字後壁拗逝，行長煞變了傷短去。

## git repo 下底个 git submodule

我進前將一堆 ~/.config/nvim-\* 攏徙入去 `~/lua/nvim-backup/` 下底，因為遮个
設定目錄攏有做 git repo，但是 `~/lua` 本身也有 git repo，所致 `~/lua` 个 git
會將 nvim-backup/ 下底个物件看做 submodule，我若扑 `git status` 就會一直
顯示遐个物件，袂因為我佇 ~/lua/.gitignore 加入 `nvim-backup/` 就來消失。

### Warp AI 教我處理

The issue was that nvim-backup/ and its subdirectories were already being
tracked by git as submodules/repositories before you added them to .gitignore.
The .gitignore file only affects untracked files - it doesn't ignore files that
are already being tracked.

What I did:

1. Used git rm --cached -r nvim-backup/ to remove them from git tracking while
   keeping the files locally
2. Committed the change to finalize the removal from git tracking

Result:

- The directories still exist locally in your filesystem
- Git is no longer tracking them
- Your .gitignore rules are now effective for these directories
- Your working tree is clean

Now if you make any changes inside nvim-backup/ directories, git will ignore
them completely thanks to your .gitignore entries.

## AstroNvim treesitter 處理 Markdown 開始重耽

佇 MD 檔揤 `J` 欲連接兩逝字就會出現錯誤訊息：

> [!ERROR]
> Error executing vim.schedule lua callback: .../neovim/0.11.2/share/nvim/runtime/lua/vim/treesitter.lua:195: Index out of bounds  
> stack traceback:  
>  [C]: in function 'nvim_buf_get_text'  
>  .../neovim/0.11.2/share/nvim/runtime/lua/vim/treesitter.lua:195: in function 'get_node_text'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/query.lua:718: in function 'handler'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/query.lua:909: in function '\_apply_directives'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/query.lua:1106: in function '(for generator)'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.lua:108: in function 'fn'  
>  ...2/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:650: in function 'for_each_tree'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.lua:100: in function 'cb'  
>  ...2/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:478: in function '\_run_async_callbacks'  
>  ...2/share/nvim/runtime/lua/vim/treesitter/languagetree.lua:534: in function 'parse'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.lua:90: in function 'compute_folds_levels'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.lua:308: in function 'fn'  
>  ...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.lua:275: in function <...m/0.11.2/share/nvim/runtime/lua/vim/treesitter/\_fold.  
> lua:271>  
> Error in decoration provider "line" (ns=nvim.treesitter.highlighter):  
> Error executing lua: ....2/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:365: Invalid 'end_col': out of range  
> stack traceback:  
>  [C]: in function 'nvim_buf_set_extmark'  
>  ....2/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:365: in function 'fn'  
>  ....2/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:228: in function 'for_each_highlight_state'  
>  ....2/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:317: in function 'on_line_impl'  
>  ....2/share/nvim/runtime/lua/vim/treesitter/highlighter.lua:406: in function <....2/share/nvim/runtime/lua/vim/treesitter/highlighter.  
> lua:400>

Warp AI (claude 4 sonnet)教我查以下幾項个結果：

- `foldmethod=expr`
- `foldexpr=v:lua.require'astroui.folding'.foldexpr()`
- no `~/.config/nvim/queries` directory
- `:checkhealth nvim-treesitter` shows everything is OK

伊用鋸箭法解決，佇 astrocore.lua 加入 autocmd

```lua
    autocmds = {
      -- Fix treesitter folding bug in markdown files
      markdown_fold_fix = {
        {
          event = "FileType",
          pattern = "markdown",
          callback = function()
            -- Use indent-based folding instead of treesitter for markdown
            -- This avoids the "Index out of bounds" error when joining lines
            vim.opt_local.foldmethod = "indent"
            vim.opt_local.foldexpr = ""
          end,
          desc = "Fix treesitter folding issues in markdown",
        },
      },
    },
```

按呢將 AstroNvim 我上欣賞个 folding 功能佇 MD 檔取消去，袂使！我改一下：

```lua
            vim.opt_local.foldmethod = "manual"
            -- vim.opt_local.foldexpr = ""

```

無效，我裝一个全新个 AstoNvim 來試看覓。結局全新 AstroNvim 無問題，昏倒！
我跋落重裝閣重裝个無間地獄矣！

後來閣試，全新安裝个 AstroNvim 就有問題，入來 MD 揤 `J` 即時出現迄个
treesitter 錯誤。若是 `:set foldmethod=manual` 閣做 `:set foldmethod=expr`
就袂有迄个錯誤（`foldmethod` 簡寫是 `fdm`）。

今閣將 community.pack.markdown 裝起來看覓！第一擺做 `J` 猶原會出錯，
閣來才袂。可能是時間差个問題。
