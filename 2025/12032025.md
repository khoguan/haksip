# 2025-12-03 學習日誌

即兩工咧讀 Free Pascal 相關个文件

- [x] Pascal integer types
- [x] Free Pascal compiler directives `{$H+}` and `{$J-}`
- [x] Unicode string in Free Pascal

## Pascal integer types

          signed        unsigned
1 byte    ShortInt      Byte
2 bytes   SmallInt      Word
4 bytes   LongInt       LongWord/Cardinal
8 bytes   Int64         QWord

The type "Integer" is specail in that its size depends. It may be defined as
either SmallInt(16 bits) or LongInt(32 bits). With `{$mode objfpc}`, it's
32 bits long.

## Free Pascal compiler directives `{$H+}` and `{$J-}`

Google AI:

### `{$J-}`

The {$J-} in a Free Pascal source file is a compiler directive that disallows
assignments to typed constants during program execution.

This directive controls the WritableConst feature:

{$J+} (default in Free Pascal for backward compatibility): Allows typed
constants to be treated like initialized variables, meaning their values can be
changed at run-time.

{$J-}: Enforces strict constant behavior for typed constants, preventing their
values from being modified after their initial declaration. Any attempt to
assign a new value will result in a compilation error.

The use of {$J-} is often recommended in modern Object Pascal programming to
ensure that items declared with const truly remain constant throughout the
program's execution, which can help prevent bugs and make the code more
predictable. The Free Pascal wiki provides further details on the Const section
and this directive.

### `{$H+}`

在 Free Pascal 原始檔開頭的 {$H+} 也是一個編譯器指令 (compiler
directive)，它的作用是啟用使用 長字串 (AnsiString)。

cf. https://wiki.freepascal.org/Const

{$H+}: 當你宣告一個類型為 String
但未指定長度的變數時，編譯器會將其視為動態大小的 AnsiString 類型。這是現代
Pascal（如 Delphi）的標準行為，支援超過 255 個字元的大型字串，並且是自動記憶體
管理的（有參考計數）。

{$H-} (在預設模式下的預設值): 編譯器會將未指定長度的 String 視為固定長度的
ShortString 類型，其最大長度限制為 255 個字元。

因此，使用 {$H+} 指令是為了讓你的程式碼能採用現代的字串處理方式，特別是在
處理長路徑或大量文字資料時非常重要。

你可以參考 [Free Pascal wiki](https://wiki.freepascal.org/$H) 上關於 $H 指令
的說明以獲取更多資訊。

## Using Unicode string in Free Pascal

In Free Pascal, using Unicode strings is best achieved through specific data
types and compiler directives. 

### Key Data Types

Free Pascal offers a few ways to handle Unicode: 

- UTF8String: This is an AnsiString with the CP_UTF8 code page. This is the
preferred way in modern FPC development (especially with Lazarus/LCL
applications) as it uses variable-length encoding (1-4 bytes per character) and
plays well with file I/O and standard string functions like Pos().

- UnicodeString: This type stores strings as an array of WideChars (UTF-16
encoding). It is reference-counted and dynamically sized, similar to AnsiString.

- WideString: Also uses UTF-16, but unlike UnicodeString, it is not
reference-counted on Windows, which can affect memory management. 

### Recommended Usage with UTF8String 

For most general-purpose programming, the UTF8String approach is the most
straightforward: 

1. Use Compiler Directives: Ensure your source file is saved as UTF-8 (Lazarus
   does this by default) and optionally add the {$codepage utf8} directive if
   needed, though this may have some quirks depending on the version.

2. Declare Variables as UTF8String or String (with {$H+}):

   1. Explicitly: var MyUnicodeText: UTF8String;
   2. If you use the {$H+} directive (which makes String an alias for AnsiString),
      you can assign UTF-8 data directly to a plain String variable.

3. Assign Literals: You can assign string literals containing Unicode characters
   directly if your source file is correctly encoded.

```Pascal
program UnicodeDemo;
{$mode objfpc}{$H+} // Use AnsiString (CP_ACP by default)
// For console apps on Windows, you might need to set the console output to UTF-8
// or use specific conversion functions to display correctly in the system console.

var
  Greeting: UTF8String;
  HelloInChinese: String; // Alias for AnsiString, but can hold UTF-8 data

begin
  // Literal assignment works if the .pas file is saved as UTF-8
  Greeting := 'Hello, World!';
  HelloInChinese := '你好, 世界';

  Writeln(Greeting);
  Writeln(HelloInChinese);
end.
```

Handling Conversions

If you need to convert between different formats, the Free Pascal RTL provides
functions:

- Use UTF8Encode() to convert from UnicodeString or WideString to UTF8String.
- Use UTF8Decode() to convert from UTF8String back to UnicodeString. 

For console applications, especially on Windows, you may need to convert
UTF8String to the system's local codepage for correct display using functions in
units like LazUTF8 or SysUtils depending on your environment.

The [Free Pascal wiki on Character and string types](https://wiki.freepascal.org/Character_and_string_types)
has extensive details.
