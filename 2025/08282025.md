# 2025-08-28 學習日誌

- [ ] Debug nvim-as4 folding issue
- [ ] DiffOrig 指令開拆
- [x] 將 astrocore 內底我家己个 options/mappings/autocmds/command 單摘出來
- [/] markdown formatting solution: mdformat + none-ls + stylua

## Debug nvim-as4 folding issue

### 恢復 nvim-as4 原初設定

昨昏暗欲睏个時，好玄試看覓，發現 nvim-as4 个 folding 閣故障矣！
今著改變思維，勿閣急欲重裝，著用一步一步退轉去原初設定个法度試驗看覓。

### khoguan/keymaps.lua 个問題

發現是我所設个 keymaps 去礙著 folding，共伊徙入去佮 plugins/astrocore.lua
整合做伙就正常矣，真奇怪。

閣來改做 plugSpec 个格式，對 astrocore.lua 抽出來，猶原囥轉去 lua/khoguan/
下底，才閣佇 lua/lazy_setup.lua 遐做 `import = "khoguan"`，按呢嘛無問題。

## 將 astrocore 內底我家己个 options/mappings/autocmds/command 單摘出來

抾抾過來 lua/khoguan 內底，成做四份檔案。

## DiffOrig 指令開拆

USER: explain the vimscript command:

```vimscript
set nu nornu | vert new | set bt=nofile nu nornu | r ++edit # | 0d_ | diffthis | wincmd p | diffthis
```

AGENT: That one-liner opens a side-by-side diff between your current (possibly
modified) buffer and the file as saved on disk, using a scratch window.
Step-by-step:

- set nu nornu

  - Turn on absolute line numbers and turn off relative line numbers in the
    current window.

- vert new

  - Open a new vertical split with an empty buffer.

- set bt=nofile nu nornu

  - In the new split, mark the buffer as a scratch buffer (buftype=nofile), and
    again enable absolute line numbers with no relative numbers for this window.

- r ++edit #

  - Read the alternate file (#) into the scratch buffer. In this context, “#” is
    the file in the other window (the one you’re editing). The ++edit modifier
    reads the file using the same detection as :edit (e.g., encoding/line
    endings), so it’s treated like a normal file read rather than raw bytes.

- `0d_`

  - Delete the initial empty first line created by :new, sending it to the
    black-hole register (`_`) so you don’t clobber your default yank.

- diffthis

  - Put the scratch window into diff mode.

- wincmd p

  - Jump back to the previous window (your original buffer).

- diffthis

  - Put your original window into diff mode as well.

Result: a vertical diff view comparing your current buffer (with unsaved
changes) against the saved-on-disk version of that file in the scratch window.

Tips:

- When you’re done, you can exit diff mode with :diffoff! (applies to all
  windows).
- A simpler built-in alternative is :vert diffsplit % (but that uses the file on
  disk in both windows; the above recipe keeps your unsaved edits in the
  original window).

USER: About `0d_`, why is `0` used instead of `1`. Isn't the first line of a
buffer number 1?

AGENT: Great question. Yes, buffer lines are numbered starting at 1, but in Ex
ranges (the command-line language behind : commands), 0 is a special, valid
address that means “the position before the first line.”

- 0 as an address: In Ex ranges, 0 denotes a pseudo-line before line 1. It’s
  commonly used with commands that work relative to a line number. For example:

  - Insert at top: `:0read file` (same as “read before line 1”)
  - Put at top: `:0put a`

- How it applies to 0d\_: In your pipeline, commands are Ex commands separated
  by |, so 0d\_ is parsed as:

  - `:0delete _` → delete line 1 (into the black-hole register `_`).
  - Using 0 here is just a concise idiom to remove the extra blank first line
    created by :new followed by :read.

- Could you use 1 instead? Yes. These are equivalent for this purpose:
  `:0d_`
  `:1d_`
  `:1delete _`
  They all delete the first line; 0 is just a convenient shorthand allowed by
  Ex’s range rules.

- Important distinction: In Normal mode, `0d_` would mean “go to column 0 and
  delete to the last non-blank on this line,” which does not delete the whole
  line. But inside a :…|… one-liner, it’s Ex, so it’s the line-deleting form.

USER:

The `_` (underscore) motion command is strange. The vim manual says it will do
"[count] - 1 lines downward, on the first non-blank character |linewise|." Why
does it use "[count] - 1" instead of just "[count]" lines downward?

AGENT:

Excellent observation! The `_` motion's "[count] - 1" behavior seems
counterintuitive at first, but it makes sense when you understand its design
purpose.

### The key insight: `_` targets lines, not moves lines

The `_` motion is designed to **specify a range of lines to operate on**,
starting from the current line. Think of it as "from here to line N" rather than
"move N lines down."

#### Examples to illustrate

- `d_` or `1_`: Operates on the current line only (1 - 1 = 0 lines down)

  - This makes `d_` equivalent to `dd` (delete current line)
  - And `c_` equivalent to `cc` (change current line)

- `2_`: Operates from current line through the next line (2 - 1 = 1 line down)

  - So `d2_` deletes current line + next line (2 lines total)

- `3_`: Operates from current line through 2 lines down (3 - 1 = 2 lines down)

  - So `d3_` deletes current line + next 2 lines (3 lines total)

### Why this design?

The count represents **how many lines total** you want to affect, not how many
lines to move. This makes it consistent with other line-wise operations:

`dd` = delete 1 line (current)\
`2dd` = delete 2 lines (current + next)\
`d2_` = delete 2 lines (same as 2dd)\
Without the "- 1", you'd have awkward scenarios:

- If `_` moved exactly [count] lines, then `d_` or `d1_` would delete 2 lines
  (current + 1 down), which would be inconsistent with `dd` deleting just 1 line
- You'd need `d0_` to delete just the current line, which feels unnatural

### Comparison with other motions

- `j` moves down 1 line, `2j` moves down 2 lines (movement-focused)
- `_` with count N affects N total lines starting from current (range-focused)

This is why `d3j` deletes 4 lines (current + 3 down), while `d3_` deletes 3
lines total.

The `_` motion is essentially a "linewise targeting" motion that makes it easy
to specify "operate on N lines starting here."

## markdown formatting solution: mdformat + none-ls + stylua

Warp AI 共我做出一个真正會用得个設置，用 nvim-as4 做基礎來開發个。
伊甚至著愛修改 none-ls.nvim 个 bug。

### 動著个檔案

1. `~/.config/nvim-as4/lua/plugins/none-ls.lua`
2. `~/.local/bin/mdformat-with-lua`, which is a Python script.
3. `~/pyproject.toml` which is mdformat's config file. But since we hardcoded
   the arguments in `mdformat-with-lua`, the config file won't be referred to.

### mdformat 表現評估

1. 猶原毋是真正會用得，因為無才調正確計算漢字个行長，致使有漢字个時，
   會變做躼躼長个一逝。

2. 佇行尾用 `  ` 表示 `<br>` 个 MD 格式，伊無接受，煞共我改做 `\`，真歹看。

3. 目前唯一堪用个顛倒是 range formatting, 選一節干焦英文字，`<leader>lf`
   來排版猶會使。

4. CJK markdown 排版即个主題，目前就是無一个通解，毋通閣了精神叫 Warp AI
   做這矣！

5. 拗行用手動 gw/gww 指令，formatter 叫伊做其他个排版。
