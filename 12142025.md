# 2025-12-14 學習日誌

- [ ] mason-related plugins for Neovim

## mason-related plugins for Neovim

即个問題毋然我捌問過 AI，總是ke問\--一擺。

我：In Neovim, I ran `:Lazy` and found that there are 5 mason-related plugins
loaded "mason.nvim, mason-lspconfig.nvim, mason-null-ls.nvim,
mason-nvim-dap.nvim, mason-tool-installer.nvim". Why do we need all of them? How
do they work together?

Warp AI:

Short answer: they cover different layers of tooling so you can manage,
auto-install, and wire up LSPs, linters/formatters, and debuggers from one place
without hand-rolling each integration.

How they differ and work together:
- mason.nvim
  - What it is: Core package manager UI/daemon for developer tools (LSP servers,
  linters/formatters, DAP adapters).
  - What it does: Installs, updates, uninstalls tools into a local,
  Neovim-managed directory. Provides the :Mason UI and APIs to query installed
  packages and their paths.
  - Why needed: Everything else depends on this for actual tool binaries.

- mason-lspconfig.nvim
  - What it is: Glue between mason.nvim and nvim-lspconfig.
  - What it does: Maps LSP server names between Mason and lspconfig, optionally
  auto-installs servers, and provides helpers like ensure_installed and
  automatic setup handlers.
  - Why needed: Without this, you manually keep Mason’s server names and
  lspconfig configs in sync.

- mason-null-ls.nvim
  - What it is: Glue between mason.nvim and null-ls/none-ls (the Neovim plugin
  that exposes external linters/formatters as LSP sources).
  - What it does: Maps Mason packages (e.g., prettierd, stylua, eslint_d) to
  null-ls sources, provides ensure_installed, and can auto-register sources.
  - Why needed: Simplifies managing non-LSP tools via Mason and wiring them to
  null-ls so they show up in :LspInfo and run on save/format/lint.

- mason-nvim-dap.nvim
  - What it is: Glue between mason.nvim and nvim-dap (debug adapter protocol).
  - What it does: Installs DAP adapters via Mason, maps names, and can provide
  setup helpers/handlers per adapter.
  - Why needed: Lets you manage debug adapters like js-debug, delve, codelldb
  via Mason and hook them into nvim-dap easily.

- mason-tool-installer.nvim
  - What it is: A convenience layer for “install this list of tools on
  startup/command,” spanning LSPs, DAPs, and formatters/linters.
  - What it does: Reads a single ensure_installed list (mixed tool types) and
  ensures Mason installs them all. Works across the above ecosystems so you
  don’t duplicate ensure_installed in multiple places.
  - Why needed: Centralizes desired tooling into one declarative list,
  auto-installs on fresh machines or after updates.

How they typically flow in your config:
1) mason.nvim installs binaries and provides the registry.
2) mason-tool-installer.nvim ensures your mixed tool list is present (LSPs,
DAPs, formatters/linters).
3) mason-lspconfig.nvim bridges installed LSP servers to nvim-lspconfig and can
auto-setup or run your custom setup handlers.
4) mason-null-ls.nvim bridges installed non-LSP tools to null-ls/none-ls so they
act like LSP formatters/linters.
5) mason-nvim-dap.nvim bridges installed debug adapters to nvim-dap and can run
per-adapter setup.

---

In your setup, those 5 “Mason-related” plugins are not five copies of the same
thing—they’re one core installer plus a few “bridge” plugins that hook
Mason-installed binaries into LSP, format/lint, and debugging. Because you’re on
AstroNvim + AstroCommunity, AstroNvim intentionally loads most of this stack by
default.

1) Where they’re coming from in your config

Your own lua/plugins/mason.lua and lua/plugins/none-ls.lua are currently disabled.

So the Mason stack you saw in :Lazy is coming primarily from:
•  AstroNvim core (in ~/.local/share/nvim/lazy/AstroNvim/...)
•  AstroCommunity packs you import (notably pack.python), plus your own
lua/plugins/*.lua that extend opts.

2) What each plugin is doing (as configured by AstroNvim)

A) mason.nvim (the installer + registry + UI)
AstroNvim defines Mason itself here:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/mason.lua` (1-5)

```lua
return {
  "williamboman/mason.nvim",
  cmd = { "Mason", "MasonInstall", ... },
  ...
}
```
Role: downloads/manages tool binaries. Everything else depends on this.

B) mason-tool-installer.nvim (the “single source of truth” for installs)
AstroNvim includes it and (importantly) disables its “integrations”:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/mason-tool-installer.lua`
(1-4)

```lua
opts = {
  ensure_installed = {},
  integrations = { ["mason-lspconfig"] = false, ["mason-null-ls"] = false, ["mason-nvim-dap"] = false },
},
```
Role: ensures a list of tools is installed, usually at startup (run_on_start()).

This is why you often “need” it even if you also have the bridge plugins: it’s
the part that actually auto-installs your declared tools on a new machine.

C) mason-lspconfig.nvim (bridge: Mason ↔︎ nvim-lspconfig)
AstroNvim wires LSPs like this:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/lspconfig.lua` (13-20)

```lua
{
  "williamboman/mason-lspconfig.nvim",
  opts = {
    ensure_installed = {},
    handlers = { function(server) require("astrolsp").lsp_setup(server) end },
  },
  config = function(...) require "astronvim.plugins.configs.mason-lspconfig"(...) end,
}
```

And the config explicitly does this:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/configs/mason-lspconfig.lua`
(1-1)

```lua
if is_available "mason-tool-installer.nvim" then opts.ensure_installed = nil end
```

Meaning: when mason-tool-installer exists, AstroNvim does not want
mason-lspconfig to be responsible for installing servers. It still sets up the
LSP servers/handlers; it just doesn’t own the install list.

D) mason-nvim-dap.nvim (bridge: Mason ↔︎ nvim-dap)
AstroNvim’s DAP plugin depends on it:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/dap.lua` (60-64)

```lua
{
  "jay-babu/mason-nvim-dap.nvim",
  dependencies = { "nvim-dap", "williamboman/mason.nvim" },
  opts = { ensure_installed = {}, handlers = {} },
}
```

And similarly, its config nulls ensure_installed when tool-installer is present:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/configs/mason-nvim-dap.lua`
(1-1)

```lua
if require("astrocore").is_available "mason-tool-installer.nvim" then opts.ensure_installed = nil end
```

So again: it’s mainly used for adapter setup/wiring, not as the authoritative
installer.

E) mason-null-ls.nvim (bridge: Mason ↔︎ null-ls/none-ls)

AstroNvim config also does the same “don’t use ensure_installed if
tool-installer exists”:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/configs/mason-null-ls.lua`
(1-2)

```lua
if require("astrocore").is_available "mason-tool-installer.nvim" then opts.ensure_installed = nil end
require("mason-null-ls").setup(opts)
```

In your current setup, you are using conform.nvim + nvim-lint for
format/lint (and you have none-ls.lua disabled), so mason-null-ls.nvim is likely
optional/redundant unless another module is actually using null-ls/none-ls
sources.

3) Where your install list is actually being built

Because AstroNvim wants mason-tool-installer to own installs, the most important ensure_installed values are the ones added to WhoIsSethDaniel/mason-tool-installer.nvim.

You add to that list in multiple places:

•  Lua tools (lua-language-server, stylua, luacheck) in your lua/plugins/lua.lua:

`.config/nvim/lua/plugins/lua.lua` (64-73)

```lua
{
  "WhoIsSethDaniel/mason-tool-installer.nvim",
  opts = function(_, opts)
    opts.ensure_installed = require("astrocore").list_insert_unique(opts.ensure_installed, {
      "lua-language-server",
      "stylua",
      "luacheck",
    })
  end,
},
```

•  Bash tooling in your lua/plugins/bash.lua:

`.config/nvim/lua/plugins/bash.lua` (21-24)

```lua
{ "WhoIsSethDaniel/mason-tool-installer.nvim", opts = function(_, opts)
  opts.ensure_installed = require("astrocore").list_insert_unique(opts.ensure_installed,
    { "bash-language-server", "shellcheck", "shfmt", "bash-debug-adapter" })
end },
```

•  Python pack (you import it in lua/community.lua) adds tools like
basedpyright/black/isort/debugpy:

`.local/share/nvim/lazy/astrocommunity/lua/astrocommunity/pack/python/init.lua`
(68-71)

```lua
{ "WhoIsSethDaniel/mason-tool-installer.nvim", opts = function(_, opts)
  opts.ensure_installed = require("astrocore").list_insert_unique(opts.ensure_installed,
    { "basedpyright", "black", "isort", "debugpy" })
end },
```

4) Practical takeaway: do you “need” all five?

•  You need mason.nvim if you want Neovim-managed installs.
•  You need mason-lspconfig.nvim if you want Mason-installed LSP servers to be
automatically wired into nvim-lspconfig (AstroNvim uses it).
•  You need mason-nvim-dap.nvim if you want Mason-installed debug adapters wired
into nvim-dap (AstroNvim uses it).
•  You only need mason-null-ls.nvim if you are actually using null-ls/none-ls as
the integration layer for linters/formatters. If you’re standardizing on
conform.nvim + nvim-lint, you can often drop it.
•  mason-tool-installer.nvim is the “quality-of-life” piece that turns all of
the above into “declare tools once, auto-install everywhere”—and AstroNvim has
structured things so it’s the primary installer.

So the “work together” picture in your running config is:

1) mason.nvim provides installs + registry + paths (:Mason UI).
2) mason-tool-installer.nvim reads the combined ensure_installed list (from
AstroNvim + imported packs + your lua/plugins/*.lua) and installs everything.
3) mason-lspconfig.nvim sets up Mason-installed LSP servers through AstroNvim’s
astrolsp handler wiring.
4) mason-nvim-dap.nvim sets up Mason-installed debug adapters for nvim-dap.
5) mason-null-ls.nvim is present, but since your none-ls config file is disabled
and you’re using conform.nvim + nvim-lint in places, it may be mostly idle
unless some other enabled module is using null-ls/none-ls.

---

mason-null-ls.nvim is only “doing something” if nvimtools/none-ls.nvim (aka
null-ls) is enabled and has sources registered. In your nv (~/.config/nvim)
setup:

1) none-ls is enabled (from AstroNvim core)
AstroNvim includes none-ls by default, and it pulls in mason-null-ls.nvim as
a dependency:

`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/none-ls.lua` (1-14)

```lua
return {
  "nvimtools/none-ls.nvim",
  main = "null-ls",
  dependencies = {
    {
      "jay-babu/mason-null-ls.nvim",
      dependencies = { "williamboman/mason.nvim" },
      cmd = { "NullLsInstall", "NullLsUninstall" },
      opts = { ensure_installed = {}, handlers = {} },
      config = function(...) require "astronvim.plugins.configs.mason-null-ls"(...) end,
    },
  },
  event = "User AstroFile",
}
```

So: even if you never configured any null-ls sources yourself,
mason-null-ls.nvim can still appear “loaded” simply because AstroNvim loads
none-ls, and none-ls depends on it.

2) But in your config, you are not currently registering any none-ls sources

Your own ~/.config/nvim/lua/plugins/none-ls.lua (which would register sources
like selene) is disabled:

`.config/nvim/lua/plugins/none-ls.lua` (1-1)

```lua
if true then return {} end -- WARN: REMOVE THIS LINE TO ACTIVATE THIS FILE
```

And you’re not importing any AstroCommunity modules that add none-ls sources (e.g. pack.fish, pack.nix, etc. do, but you didn’t import those in lua/community.lua).

That means in practice:
•  none-ls is installed/available
•  mason-null-ls is installed/available
•  but they likely aren’t actively providing any formatter/linter sources right now

3) Quick ways to confirm inside Neovim
•  :NullLsInfo (AstroNvim even maps this as <Leader>lI when available)
•  If it shows “no sources” (or an empty list), then mason-null-ls is effectively idle.

4) What this implies
•  If you’re standardizing on conform.nvim (format) + nvim-lint (lint), then none-ls + mason-null-ls may be redundant for you.
•  If you want Mason-managed tools to show up as null-ls sources, you’d either:
◦  enable your lua/plugins/none-ls.lua, or
◦  import a community pack that configures none-ls sources, or
◦  configure handlers in mason-null-ls to register sources.

Warp AI: If you want, I can point you to the cleanest way (in AstroNvim terms)
to disable nvimtools/none-ls.nvim (and therefore stop pulling in
mason-null-ls.nvim) while keeping your current conform.nvim + nvim-lint workflow.

我：OK, point me but only for me to know it.

If you want to stop nvimtools/none-ls.nvim from loading (and therefore stop
pulling in mason-null-ls.nvim) in AstroNvim, the clean pattern is: add a user
plugin spec that disables it.

Create a file like ~/.config/nvim/lua/plugins/disable-none-ls.lua with:

```lua
return {
  { "nvimtools/none-ls.nvim", enabled = false },
  { "jay-babu/mason-null-ls.nvim", enabled = false }, -- optional: belt-and-suspenders
}
```

Notes (so you understand what’s happening, not because you must do it):

•  In AstroNvim core, mason-null-ls.nvim is pulled in as a dependency of
nvimtools/none-ls.nvim (see
~/.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/none-ls.lua), so
disabling none-ls is usually sufficient.

•  Keeping conform.nvim + nvim-lint won’t be affected by this, since those are
separate integrations.

---

In
`.local/share/nvim/lazy/AstroNvim/lua/astronvim/plugins/mason-tool-installer.lua`
(1-4), why does AstroNvim disable the "integrations"?

```lua
opts = {
  ensure_installed = {},
  integrations = { ["mason-lspconfig"] = false, ["mason-null-ls"] = false, ["mason-nvim-dap"] = false },
},
```

AstroNvim disables those mason-tool-installer “integrations” to avoid
double-install / double-setup ownership and to keep AstroNvim’s own setup
pipeline in control.

What “integrations” mean in mason-tool-installer.nvim:

•  When an integration is enabled, mason-tool-installer will try to cooperate
with (and in some cases infer/trigger installs from) plugins like
mason-lspconfig, mason-null-ls, and mason-nvim-dap.
•  That can make “who is responsible for installing what” less explicit, and can
cause repeated install checks or confusing behavior when multiple plugins each
have their own ensure_installed.

What AstroNvim is doing instead (very intentionally):

1) One install list: AstroNvim wants mason-tool-installer.nvim to be the single
place that actually drives installation (via a combined ensure_installed list
built up from core + community packs + your overrides).

2) The bridge plugins only wire things up:
•  mason-lspconfig.nvim sets up LSP servers via AstroNvim’s astrolsp handler.
•  mason-nvim-dap.nvim sets up DAP adapters for nvim-dap.
•  mason-null-ls.nvim sets up null-ls/none-ls integration (if you use it).

3) AstroNvim disables the bridge plugins’ ensure_installed when tool-installer
is present:
•  e.g. in astronvim/plugins/configs/mason-lspconfig.lua, it does
opts.ensure_installed = nil if mason-tool-installer.nvim is available.
•  same pattern for mason-null-ls and mason-nvim-dap.

So: if AstroNvim left mason-tool-installer integrations enabled, you’d get
overlapping “helpfulness” from multiple sides:

•  the bridge plugin tries to manage installs (via its own ensure_installed)
•  tool-installer tries to integrate with the bridge plugin
•  AstroNvim tries to null out the bridge plugin’s ensure_installed anyway

Disabling integrations makes the behavior deterministic:
•  Installs happen because mason-tool-installer runs
•  Setup happens because the bridge plugins run
•  No plugin is trying to be “smart” about the others.
