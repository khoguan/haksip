# 2025-08-19 學習日誌

- [ ] omni completion with `<C-x><C-o>`
- [x] map J to avoid treesitter out of bounds error
- [ ] 寬寬仔試用 dprint 佮伊个 format_on_save 功能
- [ ] blink.cmp 設定

## nvim built-in omni completion

後來漸漸予閣較先進个 auto-completion 取代。我沓沓仔來體驗 blink auto-completion
个好處。總是，目前个感受是扑漢字个時無啥路用，伊無才調預測我欲扑啥漢字。將來
auto-completion 加入 AI 支援了後，可能就會改善。

## map J to avoid treesitter out of bounds error

既然拄入來 MD 个時，揤 `J` 會引發 treesitter out of bounds error，今我著共伊
加料重包裝：

```lua
vim.keymap.set("n", "J", function()
  vim.opt.foldmethod = "manual"
  vim.cmd("normal! J")
  vim.opt.foldmethod = "expr"
end, { noremap = true, silent = true, desc = "Join line, preserving folds" })
```

註：寫踮 astrocore.lua 內底个時，愛照 astrocore 特殊寫法去改。

構想佮實作攏成功矣！袂閣出現 treesitter error 矣！

嘛是閣走出來！Google AI 解說：

> That error is a known issue with the treesitter-highlighter in Neovim,
> specifically when using certain language grammars. It occurs because the J
> (join lines) command modifies the buffer in a way that the highlighter
> doesn't expect, leading to an invalid state. The error message Invalid
> 'end_row': out of range indicates that the highlighter is trying to apply a
> decoration to a line that no longer exists after the join operation.
>
> To fix this, you can disable the treesitter module for markdown files in your
> AstroNvim configuration. This is often the simplest and most effective
> solution, as it prevents the treesitter-highlighter from interfering with the
> join command.

伊提出个解法嘛無效：

1. Open your AstroNvim configuration file. This is typically located at
   ~/.config/nvim/lua/user/init.lua.

2. Add a line to disable treesitter for markdown files. You can do this by
   setting vim.g.markdown_disable_treesitter = 1 or by adding the markdown
   filetype to your ensure_installed list in your treesitter configuration and
   explicitly disabling it. A cleaner way is to create a new file specifically
   for this override.

Here's an example of how you can add the configuration to your
~/.config/nvim/lua/user/init.lua file:

```lua
return {
  -- ... other configuration ...

  -- Disable treesitter for markdown files to fix the 'J' command error
  {
    "nvim-treesitter/nvim-treesitter",
    opts = function(_, opts)
      -- This line explicitly removes markdown from the list of parsers
      opts.ensure_installed = vim.tbl_filter(
        function(parser)
          return parser ~= "markdown"
        end,
        opts.ensure_installed
      )
    end,
  },
}
```

管待伊啊，橫直閣會用得。

已經確定，只要 treesitter 有安裝 markdown parser 就一定有即个問題，全然就是
treesitter 个責成，等伊更新就好。 

## blink.cmp 設定

預設予我上討厭个所在就是 `auto_insert = true` 加上
`["<CR>"] = { "accept", "fallback" },` 害我定定佇 MD 檔行尾揤 Enter
欲進入下一逝个時煞誤揤著 completion list 个第一个項目共伊扑出來。
今改做按呢了後來試，看會閣發生即種情形袂？

```lua
return {
  "Saghen/blink.cmp",
  opts = {
    keymap = {
      ["<CR>"] = false,
    },
    completion = {
      list = { selection = { preselect = false, auto_insert = false } },
    },
  },
}
```
