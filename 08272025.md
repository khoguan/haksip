# 2025-08-27 學習日誌

- [x] vim recovery mode
- [ ] Markdown foloding 故障
- [x] community 將 prettierd 對真濟 pack 刣捒矣
- [x] .zshrc 內底 function 定義中个 `exit`
- [x] marksman 个功能無包括 formatting
- [ ] 舊新版 pack.markdown 實驗
- [ ] 建置 nvim-as4
- [x] .zshrc & .bashrc 內底 fzf 設定用固定版本無好

## 繼續研究 recovery mode

一寡試驗結果，寫入去昨昏个學習日誌。

## Markdown folding 故障

早起發現 MD folding 重耽，無法度收合標題。各標題邊=仔个 foldcolumn 个 > 記號
嘛消失去矣。感覺 Neovim 配合各種 plugins 無啥穩定，本來會用得个，毋知按怎就
失靈去矣。

比較：nvim-as1, nvim-as2, nvim-as3 目前攏無問題。我閣欲陷入重裝个地獄矣--simh？

將 styler.lua 關起來，敢哪閣恢復正常矣？

袂穩定，重開kā看，閣無--去矣！

## community 將 prettierd 對真濟 pack 刣捒矣

Issues 有儂講 prettierd 無穩定，有儂講 prettierd 有單獨个 pack 矣，無必要
閣分別佇各種檔案類型个 pack 內底閣設。總講一句，怹就共一大堆 filetype pack
內底个 prettierd 相關个部份攏刣挕捒啦！包括 `ensure_installed`，閣有
`conform.nvim` 規个 plugSpec！上新版个 pack.markdown 只賰一个 marksman。

本底有裝个使用者，今怹更新 astrocommunity 了後，毋知會發生啥？怹若無另外裝
community.pack.prettier（內底實際是裝 prettierd），按呢重開 nvim 了後，
是毋是會發現怹本來倚靠來自動排版个 prettierd 無--去矣！抑是暫時閣佇咧，
但是將 nvim config repo 佇別台機器重建个時，就看袂著 prettiered 矣？
這攏毋是好體驗。

袂使戇戇仔更新 Lazy plugins，commit 記錄愛先看一下才揤 `U`。

## .zshrc 內底 function 定義中个 `exit`

當初 Warp AI 共我 port .bashrc 過來 .zshrc 个時，無充份檢討一寡 function
定義中無相容个指令，致使後日我三不五時會著觸[tio̍h-tak]。

親像最近定定毋知扑啥指令，zsh 視窗就消失去，後來才發現是重定義過个 cd
function 內底个 exit 咧作怪。問 Warp AI 確認，伊講：

Yes, bash and zsh are incompatible regarding the exit command when used inside
functions:

- In bash: exit in a function acts more like return - it only exits the
  function
- In zsh: exit in a function terminates the entire shell session

The solution is to replace all occurrences of exit with return (or return 1 to
indicate an error) in shell functions. I've updated all the affected functions
in your .zshrc:

1. The cd function
1. The fcd function (fzf cd)
1. The mcd function (mkdir and cd)
1. The cdwhich function
1. The y function (yazi)（我進一步將 `|| exit` 直接刪除）

These functions now properly return an error code instead of terminating your
shell session when they encounter an error.

## marksman 个功能無包括 formatting

"artempyanykh/marksman" README:

> Using LSP protocol it provides completion, goto definition, find references,
> rename refactoring, diagnostics, and more. In addition to regular Markdown,
> it also supports wiki-link-style references that enable Zettelkasten-like
> note taking.

參考
https://medium.com/@chrisatmachine/lunarvim-improve-markdown-editing-with-marksman-739d06c73a26
示範一寡 note-taking 功能。

## 舊新版 pack.markdown 實驗

### 第一回合實驗

1. 新版無 prettierd
1. 換舊版有 prettierd，重開 MD 檔看覓，照講愛看著 prettierd 出現佇狀態列。
   **結果**：mason-tool-installer 顯示安裝中、安裝成功个訊息。format_on_save
   也成功 format buffer，也仝款無法度 range formatting。
1. 閣換新版，看 prettierd 會無--去袂？
   **結果**：閣佇咧。
1. 若閣佇咧，`:MasonUninstall prettierd`，重開 MD 檔看覓。
   結果：免重開，只要存檔 prettierd 就消失去。
1. prettierd 若無--去，證明預測正確。
   結論：理解正確！

### 第二回合實驗

1. 新版無 prettierd
1. 換舊版，而且將舊版中个 conform 刣捒（雖然是設做 optional，別位無執行 conform
   所以伊並無起來，總是佇遮完全確定伊無影響在內。）
1. 看 prettierd 是毋是除了佇 MD 會作用，佇其他伊有支援个檔案類型攏有咧作用，
   按呢會使證明 mason-null-ls 是無差別咧應用伊。
   小結論：猜測正確，mason-null-ls 是無差別咧應用 prettierd！
1. 予 conform 接手管理 prettierd，看會限制伊个應用範圍袂。
   結果：無法度，`NullLsInfo` 會一直顯示講伊有管著 prettierd

## 建置 nvim-as4

### 改用 mdformat

1. 用新版个 community.pack.markdown - 干焦 marksman 一項

1. 佇「原廠」个 plugins/{mason,none-ls}.lua 加入 mdformat - 本來欲用 dprint，
   無疑悟伊無支援！效果：mdformat 真強勢，預設會將 ordered list 攏改用 1.
   這是欲 render 做其他格式个 MD 較好个選擇，總是，我主要是欲直接看 MD source，
   所以較無肆是。另外，伊也會共我个 `\--` 抑是 `\-\-` 輕聲記號攏取消 `\`，
   台羅音標括號 `\[tâi-lô]` 伊嘛會刪除反斜線，這就奇妙矣。愛來研究伊个 config
   file. 目前用 `gh markdown-preview` 來看，`--` 會凍照我个意思分開顯示，
   袂連做一橫。

   [none-ls 對 mdformat 个 config file](https://github.com/nvimtools/none-ls.nvim/blob/main/lua/null-ls/builtins/formatting/mdformat.lua)

1. 佇 `:NullLsInfo` 內底顯示伊所管个 Active source(s) 有兩套，攏是 mdformat。
   我試將頭前 plugins/mason.lua 禁起來，閣 `:MasonUninstall mdformat` 干焦留
   none-ls.lua，果然就變一个爾爾。

   > Active source(s)
   >
   > - name: mdformat
   > - filetypes: markdown
   > - methods: formatting

1. 按呢看起來，即个 `none-ls.nvim` 有夠厲害，只要一逝字就即時會用得。
   無滿意个設定項目家己才閣設專門个 config file 另外微調就好。想想咧，
   伊無靠 mason 所裝个 nvim 專用 mdformat，可能是因為我外部有裝 mdformat 矣，
   若無，應該也是無伊法。

1. `:NullLsInfo` 真心適，閣會顯示針對 MD 伊閣有支援个別款 linters 佮 formatters
   予儂參考。formatters 來講，就有：\
   cbfmt | markdownlint | mdformat | ocdc | prettier | prettierd | remark | textlint

## .zshrc & .bashrc 內底 fzf 設定用固定版本無好

### .zshrc solution

USER:
In my .zshrc, line 109-115 are about fzf integration. It tests if
`/opt/homebrew/Cellar/fzf/0.63.0/shell/completion.zsh` exists. But everytime
when Homebrew upgrade fzf, that line will not work. Is there a way to use glob
patter like `/opt/homebrew/Cellar/fzf/*/shell/completion.zsh` to test if it
exists in .zshrc ?

AGENT:
I'll help you modify your .zshrc to use a glob pattern for the fzf path so it
works regardless of the version. Let me first check your current .zshrc
configuration.
Read files: ~/.zshrc (13-212)

Now I can see the fzf integration section on lines 109-115. Yes, you can use a
glob pattern in zsh to test for the existence of files. In zsh, you have
several options for handling glob patterns. Let me show you how to modify your
.zshrc to make it version-agnostic.

Perfect! I've successfully updated your `.zshrc` file to use glob patterns for
the fzf integration. Here's what I changed:

#### What was changed:

The old version (lines 109-115) had hardcoded version `0.63.0`:

```zsh
# fzf integration
if [ -f /opt/homebrew/Cellar/fzf/0.63.0/shell/completion.zsh ]; then
  source /opt/homebrew/Cellar/fzf/0.63.0/shell/completion.zsh
fi
if [ -f /opt/homebrew/Cellar/fzf/0.63.0/shell/key-bindings.zsh ]; then
  source /opt/homebrew/Cellar/fzf/0.63.0/shell/key-bindings.zsh
fi
```

The new version now uses glob patterns:

```zsh
# fzf integration
# Use glob pattern to find fzf files regardless of version
fzf_completion=(/opt/homebrew/Cellar/fzf/*/shell/completion.zsh(N))
if [[ -n $fzf_completion ]]; then
  source ${fzf_completion[1]}
fi

fzf_keybindings=(/opt/homebrew/Cellar/fzf/*/shell/key-bindings.zsh(N))
if [[ -n $fzf_keybindings ]]; then
  source ${fzf_keybindings[1]}
fi
```

#### How it works:

1. **Glob expansion with array assignment**:
   `fzf_completion=(/opt/homebrew/Cellar/fzf/*/shell/completion.zsh(N))`

   - The `*` matches any version directory
   - The `(N)` is a zsh glob qualifier that makes the pattern return empty if
     no matches are found (instead of an error)
   - The result is stored in an array variable

1. **Checking if files exist**: `if [[ -n $fzf_completion ]]`

   - This checks if the array is non-empty (i.e., files were found)

1. **Sourcing the first match**: `source ${fzf_completion[1]}`

   - Uses the first element of the array (in case multiple versions exist)
   - In zsh, arrays are 1-indexed

Now your fzf integration will work automatically regardless of which version
Homebrew has installed, and you won't need to update the `.zshrc` file every
time fzf is upgraded!

To test if it works, you can reload your shell configuration:
source ~/.zshrc

### .bashrc solution

USER:
Thanks. It works now. BTW, line 8-9 of my `~/.bashrc` are of the same issue.
What can we do?

AGENT:
Let me check your `~/.bashrc` file to see the fzf integration there and fix it
for bash.
Read files: ~/.bashrc (1-200)

I can see lines 8-9 have the same hardcoded fzf version. For bash, we need to
use a different approach since bash doesn't have the same glob features as zsh.
Let me update your `.bashrc` file to use a more portable solution:

Perfect! I've updated your `.bashrc` file to use a version-agnostic approach
for fzf integration. Here's what was changed:

#### What was changed in `.bashrc`:

The old version (lines 7-9):

```bash
# Enables Ctrl+R (command history), Ctrl+T (file search), Alt+C (directory search)
[ -f /opt/homebrew/Cellar/fzf/0.63.0/shell/completion.bash ] && source /opt/homebrew/Cellar/fzf/0.63.0/shell/completion.bash
[ -f /opt/homebrew/Cellar/fzf/0.63.0/shell/key-bindings.bash ] && source /opt/homebrew/Cellar/fzf/0.63.0/shell/key-bindings.bash
```

The new version:

```bash
# Enables Ctrl+R (command history), Ctrl+T (file search), Alt+C (directory search)
# Use glob pattern to find fzf files regardless of version
for fzf_completion in /opt/homebrew/Cellar/fzf/*/shell/completion.bash; do
  [ -f "$fzf_completion" ] && source "$fzf_completion" && break
done

for fzf_keybindings in /opt/homebrew/Cellar/fzf/*/shell/key-bindings.bash; do
  [ -f "$fzf_keybindings" ] && source "$fzf_keybindings" && break
done
```

#### How the bash solution works:

1. **For loop with glob expansion**:
   `for fzf_completion in /opt/homebrew/Cellar/fzf/*/shell/completion.bash`

   - Bash expands the glob pattern to match all files that fit the pattern
   - The loop iterates through each match

1. **File existence test and source**:
   `[ -f "$fzf_completion" ] && source "$fzf_completion"`

   - Tests if the file exists and is a regular file
   - If true, sources the file

1. **Break after first match**: `&& break`

   - Stops after finding and sourcing the first match (in case multiple
     versions exist)

Now both your `.zshrc` and `.bashrc` files will automatically work with any
version of fzf that Homebrew installs, and you won't need to update them when
fzf gets upgraded!

To test the bash configuration, you can either:

- Start a new bash shell: `bash`
- Or source the file in an existing bash shell: `source ~/.bashrc`
